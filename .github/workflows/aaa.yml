name: Hello World

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

on:
  push:
    branches:
      - 'main'

permissions:
  contents: read
  issues: read
  checks: write
  pull-requests: write

jobs:
  hello:
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Print Hello World
        run: echo "Hello World"

      - name: Add .env file
        run: echo "${{ secrets.DEV_ENV }}" > .env

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci

      - name: Create Reports Directory
        run: mkdir -p reports
  
      - name: Run Tests and Capture Output
        run: npm test
        
      - name: Test Report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: JEST Tests
          path: reports/test-results.xml
          reporter: jest-junit
          fail-on-error: false

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action/composite@v2
        if: always()
        with:
          files: |
            test-results.xml
            test-results/**/*.xml
            test-results/**/*.trx
            test-results/**/*.json

      - name: Comment Check Run
        uses: actions/github-script@v7
        with:
          script: |
            const { context, github } = require('@actions/github');
      
            // Lấy ID của check run mới nhất
            const checkRunId = context.payload.check_run.id;
      
            // Gọi API để lấy thông tin của check run
            const response = await github.checks.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              check_run_id: checkRunId,
            });
      
            // Lấy nội dung của bảng check run
            const checkRunOutput = response.data.output;
      
            // Tạo comment với nội dung của bảng check run
            github.issues.createComment({
              ...context.repo,
              issue_number: context.payload.pull_request.number,
              body: `Check the detailed test results [here](${checkRunOutput.summary})`,
            });
    
      - name: Comment PR with Test Results
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          comment_body="ISSUE"
          if [ -z "$comment_body" ]; then
            comment_body="No test results found."
          fi
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "{\"body\":\"Test Results:\\n\`\`\`\\n${comment_body}\\n\`\`\`\"}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"